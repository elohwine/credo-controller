version: '3.8'

services:
  # =====================================
  # Back-end API (Issuer)
  # =====================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: credo-api
    restart: unless-stopped
    ports:
      - "3000:3000" # Issuer Agent
    environment:
      - PORT=3000
      - WALLET_KEY=development-wallet-key-123
      - JWT_SECRET=development-jwt-secret-456
      - LOG_LEVEL=debug
      - PUBLIC_BASE_URL=http://172.19.0.10:3000
      - WALLET_URL=http://localhost:4000
      - PERSISTENCE_DB_PATH=/app/data/persistence.db
      - ASKAR_STORAGE_PATH=/app/data/askar-issuer
      # Only run Issuer
      - HOLDER_API_PORT=7000
      # EcoCash Payment Mode: 'true' = simulated (auto-webhook), 'false' = live (USSD PIN push)
      - ECOCASH_SANDBOX=true
      - ECOCASH_WEBHOOK_SECRET=test-webhook-secret
      # Event-Based Offer Push Config (Docker Internal Network)
      # Disabled for manual acceptance flow (MVP Fastlane)
      # - OFFER_PUSH_URL=http://172.19.0.11:7000/api/wallet/holder-wallet/exchange/useOfferRequest
      # - OFFER_PUSH_API_KEY=holder-api-key-12345 
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ["node", "./samples/startServer.js"]
    volumes:
      - ./data:/app/data
    networks:
      credo-net:
        ipv4_address: 172.19.0.10
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 10s
      timeout: 10s
      retries: 5

  # =====================================
  # Holder API (Tenant Wallet)
  # =====================================
  holder-api:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: credo-holder
    restart: unless-stopped
    ports:
      - "7000:7000" # Holder Agent
      - "7001:7001" # Holder Inbound
    environment:
      - PORT=7000
      - HOLDER_API_PORT=7000
      - HOLDER_INBOUND_PORT=7001
      - ISSUER_API_URL=http://172.19.0.10:3000
      - PUBLIC_BASE_URL=http://172.19.0.10:3000
      - WALLET_URL=http://localhost:4000
      - JWT_SECRET=development-jwt-secret-456
      - LOG_LEVEL=debug
      - ASKAR_STORAGE_PATH=/app/data/askar-issuer
    command: ["node", "./samples/startHolderServer.js"]
    volumes:
      - ./data:/app/data
    networks:
      credo-net:
        ipv4_address: 172.19.0.11
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:7000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 15s
      timeout: 15s
      retries: 5
      start_period: 20s

  # =====================================
  # Wallet UI
  # =====================================
  wallet:
    build:
      context: ./credo-ui/wallet
      dockerfile: Dockerfile
    container_name: credo-wallet
    restart: unless-stopped
    ports:
      - "4000:4000"
    environment:
      - PORT=4000
      - PROXY_TARGET_HOST=172.19.0.11
      - PROXY_TARGET_PORT=7000
      - NUXT_PUBLIC_WALLET_BACKEND_URL=http://localhost:7000
      - NUXT_PUBLIC_FINANCE_API_URL=http://localhost:7000
      - NUXT_PUBLIC_CREDENTIALS_REPOSITORY_URL=http://localhost:3000
      - NUXT_PUBLIC_ISSUER_CALLBACK_URL=http://localhost:3000
    depends_on:
      api:
        condition: service_healthy
      holder-api:
        condition: service_healthy
    networks:
      credo-net:
        ipv4_address: 172.19.0.12

  # =====================================
  # HR Portal UI
  # =====================================
  portal:
    build:
      context: ./credo-ui/portal
      dockerfile: Dockerfile
    container_name: credo-portal
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - PORT=5000
      # Client-side (browser) URLs - must use localhost or public URLs
      - NEXT_PUBLIC_VC_REPO=http://localhost:3000
      - NEXT_PUBLIC_BACKEND_URL=http://localhost:3000
      - NEXT_PUBLIC_HOLDER_URL=http://localhost:7000
      - NEXT_PUBLIC_WALLET_URL=http://localhost:4000
      # API Keys - DIFFERENT keys for different backends!
      - NEXT_PUBLIC_CREDO_API_KEY=test-api-key-12345
      - NEXT_PUBLIC_HOLDER_API_KEY=holder-api-key-12345
      # Server-side (SSR/API routes) URLs - use Docker bridge IPs
      - BACKEND_URL=http://172.19.0.10:3000
      - VC_REPO_INTERNAL=http://172.19.0.10:3000
    depends_on:
      api:
        condition: service_healthy
      holder-api:
        condition: service_healthy
    networks:
      credo-net:
        ipv4_address: 172.19.0.13

networks:
  credo-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.19.0.0/24
          gateway: 172.19.0.1

# Using host bind mount for ./data to share persistence between services
