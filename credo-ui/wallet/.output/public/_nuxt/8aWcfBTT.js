import H from"./BPxGWsFk.js";import{p as N,a as I,e as K}from"./BtARrWM9.js";import{h as W,p as S,c as r,o as n,F as A,a as l,z as P,A as M,d as R,t as k,g as e,r as U,i as C,P as Y,n as L,j as Z,e as G,b as q,w as J,f as V}from"#entry";import{c as Q}from"./BAsolvdk.js";import{C as X}from"./CPWQvqDN.js";import{u as _}from"./DGaPg-gW.js";import{d as ee}from"./6yF6Fmpd.js";import{L as te}from"./BwzTearg.js";import{V as z}from"./BJxc1Al6.js";import"./D-q_bWm-.js";const se={class:"sm:flex justify-between items-center"},ie={key:0,width:"16",height:"16",viewBox:"0 0 17 10",fill:"none",xmlns:"http://www.w3.org/2000/svg"},le={key:1,width:"16",height:"16",viewBox:"0 0 10 18",fill:"none",xmlns:"http://www.w3.org/2000/svg"},oe={key:0,class:"flex items-center gap-2"},ne=["disabled","checked"],re={key:1},ae={key:0},de={class:"mt-1 divide-y px-10 divide-gray-100"},ce={class:"min-w-0 flex-1 text-sm leading-6"},ue=["for"],me={class:"ml-3 flex h-6 items-center"},ve=["id","name","disabled","checked","onClick"],fe=W({__name:"CredentialDisclosure",props:{credential:{},disclosures:{},selection:{},disclosureModalState:{},toggleDisclosure:{type:Function},addDisclosure:{type:Function},removeDisclosure:{type:Function}},setup(t){const u=t,b=S(()=>{const D=u.credential.parsedDocument??N(u.credential.document).vc??N(u.credential.document);return D?.type?.at(-1)??D.vct.split("/").pop()??"Unknown"}),w=S(()=>b.value.replace(/([a-z0-9])([A-Z])/g,"$1 $2")),m=S(()=>I(u.credential.disclosures||""));return(D,c)=>(n(),r(A,null,[t.credential.disclosures?(n(),r("div",{key:0,class:P(["w-full",{"text-[#7B8794]":!t.selection[t.credential.id]}])},[l("div",se,[l("div",{onClick:c[0]||(c[0]=f=>t.toggleDisclosure(t.credential.id)),class:P([{"font-semibold":t.disclosureModalState[t.credential.id]&&t.selection[t.credential.id],"text-black-800":t.selection[t.credential.id]},"flex gap-3 items-center cursor-pointer"])},[R(k(e(w))+" ",1),t.disclosureModalState[t.credential.id]?(n(),r("svg",ie,[...c[2]||(c[2]=[l("path",{d:"M16 1L8.5 8.5L1 1",stroke:"black","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)])])):(n(),r("svg",le,[...c[3]||(c[3]=[l("path",{d:"M1.25 1.5L8.75 9L1.25 16.5",stroke:"#323F4B","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)])]))],2),l("div",null,[t.disclosureModalState[t.credential.id]?(n(),r("div",oe,[c[4]||(c[4]=R(" Disclose All ",-1)),l("input",{type:"checkbox",disabled:!t.selection[t.credential.id],class:"h-4 w-4 rounded border-gray-300 text-primary-400 focus:ring-primary-500",onClick:c[1]||(c[1]=f=>t.disclosures[t.credential.id]=f.target?.checked?e(m):[]),checked:t.disclosures[t.credential.id]?.length===e(m)?.length},null,8,ne)])):(n(),r("div",re,k(t.disclosures[t.credential.id]===void 0?`Disclosing 0 of ${e(m).length} attributes`:t.disclosures[t.credential.id]?.length===e(m).length?"Disclosing all attributes":`Disclosing ${t.disclosures[t.credential.id].length} of ${e(m).length} attributes`),1))])]),t.disclosureModalState[t.credential.id]?(n(),r("div",ae,[c[5]||(c[5]=l("div",{class:"flex items-center mt-1"},[l("div",{class:"flex-1 border-t border-gray-300"}),l("div",{class:"mx-3 text-gray-400"},"Attributes to disclose"),l("div",{class:"flex-1 border-t border-gray-300"})],-1)),l("div",de,[(n(!0),r(A,null,U(e(m),(f,p)=>(n(),r("div",{key:p,class:"relative flex items-start py-1"},[l("div",ce,[l("label",{for:`disclosure-${t.credential.id}-${f[0]}`},[l("span",{class:P({"text-black-800":t.selection[t.credential.id]})},k(f[1].charAt(0).toUpperCase()+f[1].slice(1)),3)],8,ue)]),l("div",me,[l("input",{id:`disclosure-${t.credential.id}-${f[0]}`,name:`disclosure-${f[0]}`,class:"h-4 w-4 rounded border-gray-300 text-primary-400 focus:ring-primary-500",type:"checkbox",disabled:!t.selection[t.credential.id],checked:t.disclosures[t.credential.id]&&t.disclosures[t.credential.id].find(h=>h[0]===f[0]),onClick:h=>h.target?.checked?t.addDisclosure(t.credential.id,f):t.removeDisclosure(t.credential.id,f)},null,8,ve)])]))),128))])])):M("",!0)],2)):(n(),r("div",{key:1,class:P({"text-black-800":t.selection[t.credential.id],"text-[#7B8794]":!t.selection[t.credential.id]})},k(e(w)),3)),c[6]||(c[6]=l("hr",{class:"my-2 border-gray-200"},null,-1))],64))}});async function ge(t){const u=C(0),b=C(!1),w=C("Unknown error occurred."),m=_();async function D(s){try{return await $fetch(`/wallet-api/wallet/${m.value}/exchange/resolvePresentationRequest`,{method:"POST",body:s})}catch(a){b.value=!0;const i=a?.data?.message||a?.data?.details||a?.message||"Failed to resolve presentation request";throw w.value=i,console.error("[Presentation] Resolve request failed:",i),a}}const c=await D(ee(t.request)),p=new URL(c).searchParams,h=new URL(p.get("response_uri")??p.get("redirect_uri")??"").host,E=p.get("presentation_definition"),x=await $fetch(`/wallet-api/wallet/${m.value}/exchange/matchCredentialsForPresentationDefinition`,{method:"POST",body:E}),$=C({}),B=S(()=>Object.entries($.value).filter(s=>s[1]).map(s=>s[0]));for(let s of x)$.value[s.id]=!0;const d=C({}),y=S(()=>{if(JSON.stringify(d.value)==="{}")return null;const s={};for(let a in d.value){s[a]===void 0&&(s[a]=[]);for(let i of d.value[a])s[a].push(K(i))}return s});function j(s,a){d.value[s]===void 0&&(d.value[s]=[]),d.value[s].push(a)}function O(s,a){d.value[s]=d.value[s].filter(i=>i[0]!=a[0])}const v=C({});for(let s of x)v.value[s.id]=!1;x[u.value]&&(v.value[x[u.value].id]=!0);function g(s){v.value[s]=!v.value[s]}Y(u,()=>{for(let s of x)v.value[s.id]=!1;v.value[x[u.value].id]=!0});async function o(){const s={presentationRequest:c,selectedCredentials:B.value,disclosures:y.value},a=await fetch(`/wallet-api/wallet/${m.value}/exchange/usePresentationRequest`,{method:"POST",body:JSON.stringify(s),redirect:"manual",headers:{"Content-Type":"application/json"}});if(a.ok){const i=await a.json();i.redirectUri?L(i.redirectUri,{external:!0}):(window.alert("Presentation successful, no redirect URL supplied."),L(`/wallet/${m.value}`,{external:!0}))}else{b.value=!0;const i=await a.json();w.value=i.message||i.errorMessage||"Presentation failed",console.error("[Presentation] Accept failed:",w.value),w.value=i.message,console.log("Error response: "+JSON.stringify(i)),window.alert(i.errorMessage),i.redirectUri!=null&&L(i.redirectUri,{external:!0})}}return{currentWallet:m,verifierHost:h,presentationDefinition:E,matchedCredentials:x,selectedCredentialIds:B,disclosures:d,selection:$,index:u,disclosureModalState:v,toggleDisclosure:g,addDisclosure:j,removeDisclosure:O,acceptPresentation:o,failed:b,failMessage:w}}const he={key:1},we={class:"text-red-600 animate-pulse flex items-center gap-1 py-1"},ye={key:2,class:"my-10 mb-40 sm:mb-10 overflow-scroll"},xe={class:"col-span-1 transform hover:scale-[1.02] cursor-pointer duration-200"},ke={key:1,class:"w-full flex justify-center gap-5"},be=["disabled"],De=["disabled"],pe={key:2,class:"text-center text-[#627D98] mt-2"},Ce={class:"sm:w-[80%] md:w-[60%] mx-auto"},$e={class:"text-[#627D98] mt-8 sm:mt-0"},Fe={key:0,class:"border border-[#E4E7EB] rounded-xl p-4 mb-4 bg-white"},Me={class:"text-[#627D98]"},Pe={class:"mt-2 flex gap-2"},Se=["id","checked","onClick"],Ee={key:1},Be={key:0,class:"w-full sm:max-w-2xl sm:mx-auto"},je={class:"fixed sm:relative bottom-0 w-full p-4 bg-white/95 border-t border-[#E4E7EB] shadow-md sm:shadow-none sm:flex sm:justify-end sm:gap-4"},We=W({__name:"presentation",async setup(t){let u,b;const w=C(!1),m=C(window.innerWidth<650),D=Z(),c=D.query,f=D.params.wallet,{disclosures:p,selection:h,disclosureModalState:E,toggleDisclosure:x,addDisclosure:$,removeDisclosure:B,matchedCredentials:d,index:y,acceptPresentation:j,failed:O}=([u,b]=G(()=>ge(c)),u=await u,b(),u),v=S(()=>{const g={};for(const o of d){const s=N(o.document),a=(o.parsedDocument??s.vc??s).type??s.vct?[s.vct]:void 0,i=Array.isArray(a)&&a.length>0?a.at(-1):"unknown";g[i]||(g[i]=[]),g[i].push(o)}return g});return Y(v,g=>{for(const o in g)if(g[o].length>1){for(const s of g[o])h.value[s.id]=!1;h.value[g[o][0].id]=!0}},{immediate:!0}),c.accept&&(w.value=!0,j()),Q("Present credentials - Credentis"),(g,o)=>{const s=H,a=fe;return n(),r("div",null,[q(X,null,{default:J(()=>[o[9]||(o[9]=l("h1",{class:"mb-2 text-2xl text-center font-bold text-[#0F3F5E]"},"Present Credential",-1)),o[10]||(o[10]=l("p",{class:"text-center text-sm text-[#627D98] mb-6"}," The verifier is requesting proof â€” select a credential to present. ",-1)),e(w)?(n(),V(te,{key:0,class:"my-6 mb-12 w-full"},{default:J(()=>[...o[4]||(o[4]=[R(" Presenting credential(s)... ",-1)])]),_:1})):M("",!0),e(d).length==0?(n(),r("div",he,[l("span",we,[q(s,{name:"heroicons:exclamation-circle",class:"h-6 w-6"}),o[5]||(o[5]=R(" You don't have any credentials matching this presentation definition in your wallet. ",-1))])])):(n(),r("div",ye,[e(m)?(n(!0),r(A,{key:0},U(e(d),(i,F)=>(n(),r("div",{key:F},[l("div",xe,[q(z,{credential:i},null,8,["credential"])])]))),128)):(n(),r("div",ke,[e(d).length>1?(n(),r("button",{key:0,onClick:o[0]||(o[0]=i=>y.value--),class:P(["mt-4 text-[#0F3F5E] font-bold bg-white",{"cursor-not-allowed opacity-50":e(y)===0}]),disabled:e(y)===0},[...o[6]||(o[6]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])],10,be)):M("",!0),(n(),V(z,{key:e(y),credential:{document:e(d)[e(y)].document},class:"w-full max-w-2xl"},null,8,["credential"])),e(d).length>1?(n(),r("button",{key:1,onClick:o[1]||(o[1]=i=>y.value++),class:P(["mt-4 text-[#0F3F5E] font-bold bg-white",{"cursor-not-allowed opacity-50":e(y)===e(d).length-1}]),disabled:e(y)===e(d).length-1},[...o[7]||(o[7]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1)])],10,De)):M("",!0)])),e(m)?M("",!0):(n(),r("div",pe,k(e(y)+1)+" of "+k(e(d).length),1)),l("div",Ce,[l("div",$e,k(e(d).length>1?"Credentials":"Credential")+" to present ",1),o[8]||(o[8]=l("hr",{class:"mt-1 mb-2 border-[#E4E7EB]"},null,-1)),(n(!0),r(A,null,U(Object.keys(e(v)),i=>(n(),r("div",null,[e(v)[i].length>1?(n(),r("div",Fe,[l("div",Me," You have "+k(e(v)[i].length)+" matching credentials of the same type; please choose one. ",1),(n(!0),r(A,null,U(e(v)[i],F=>(n(),r("div",Pe,[l("input",{type:"radio",id:`${i}-grouped-credential-${F.id}`,checked:e(h)[F.id],onClick:qe=>e(v)[i].forEach(T=>e(h)[T.id]=T.id===F.id),class:"mt-1 h-4 w-4 text-[#2188CA]"},null,8,Se),q(a,{credential:F,disclosureModalState:e(E),disclosures:e(p),selection:e(h),toggleDisclosure:e(x),addDisclosure:e($),removeDisclosure:e(B)},null,8,["credential","disclosureModalState","disclosures","selection","toggleDisclosure","addDisclosure","removeDisclosure"])]))),256))])):(n(),r("div",Ee,[q(a,{credential:e(v)[i][0],disclosureModalState:e(E),disclosures:e(p),selection:e(h),toggleDisclosure:e(x),addDisclosure:e($),removeDisclosure:e(B)},null,8,["credential","disclosureModalState","disclosures","selection","toggleDisclosure","addDisclosure","removeDisclosure"])]))]))),256))])]))]),_:1}),!e(O)&&e(d).length?(n(),r("div",Be,[l("div",je,[l("button",{onClick:o[2]||(o[2]=(...i)=>e(j)&&e(j)(...i)),class:"w-full sm:w-44 py-3 mt-4 text-white rounded-xl shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all",style:{background:"linear-gradient(135deg, #2188CA, #0F3F5E)"}},k(e(d).length>1?"Disclose All":"Disclose"),1),l("button",{onClick:o[3]||(o[3]=i=>("navigateTo"in g?g.navigateTo:e(L))(`/wallet/${e(f)}`)),class:"w-full sm:w-44 py-3 mt-4 bg-white sm:border sm:border-[#CBD2D9] sm:rounded-xl text-[#0F3F5E] hover:bg-[#F0F4F8]"}," Decline ")])])):M("",!0)])}}});export{We as default};
