import{i as C,O as J,P as U,Q as W,R as V,n as A,h as z,j as R,e as P,c as i,b as M,A as v,w as q,g as r,a as l,o,f as I,t as x,d as H,F as O,r as N,z as j}from"#entry";import{c as Q}from"./BAsolvdk.js";import{C as G}from"./CPWQvqDN.js";import{L as K}from"./BwzTearg.js";import{V as S}from"./BJxc1Al6.js";import{u as X}from"./DGaPg-gW.js";import{d as Y}from"./6yF6Fmpd.js";import{g as Z}from"./_2w5uKZz.js";import"./D-q_bWm-.js";import"./BtARrWM9.js";async function ee($){const m=C(!1),y=C("Unknown error occurred."),f=X(),{data:g,pending:c}=await J(()=>$fetch(`/wallet-api/wallet/${f.value}/dids`),"$kvpLrQbSfp"),D=C(null);U(g,async t=>{await W(),D.value=t?.find(e=>e.default==!0)??t?.[0]??null});async function B(t){try{return await $fetch(`/wallet-api/wallet/${f.value}/exchange/resolveCredentialOffer`,{method:"POST",body:{credential_offer_uri:t}})}catch(e){m.value=!0;let s="Failed to resolve credential offer";const n=e.data||e.response?._data;if(typeof n=="string")try{const w=JSON.parse(n);s=w.message||w.error||n}catch{s=n}else typeof n=="object"&&n!==null?s=n.message||n.error||JSON.stringify(n):e.message&&(s=e.message);throw y.value=s,console.error("[Issuance] Resolve offer failed:",s),e}}let b;try{if(!$||!$.request)throw new Error("No request provided");b=Y($.request)}catch(t){throw V({statusCode:400,statusMessage:`Invalid issuance request: ${t?.message||t}`})}const p=await B(b);if(p==null)throw V({statusCode:400,statusMessage:"Invalid issuance request: No credential_offer"});const _=p.credential_issuer;let F;try{F=new URL(_).host}catch{F=_}const E=await $fetch(`/wallet-api/wallet/${f.value}/exchange/resolveIssuerOpenIDMetadata?issuer=${_}`),h=p.credential_configuration_ids?p.credential_configuration_ids.map(t=>E.credential_configurations_supported[t]):p.credentials.map(t=>E.credentials_supported?.find(e=>e.id===t)).filter(Boolean);let d=[];for(let t of h){if(typeof t.types<"u"){const e=t.types,s=e[e.length-1];d.push(s)}if(typeof t.credential_definition<"u"){const e=t.credential_definition.type,s=e[e.length-1];d.push(s)}if(typeof t.vct<"u"){const e=await fetch(`/wallet-api/wallet/${f.value}/exchange/resolveVctUrl?vct=${t.vct}`);if(e.status<200||e.status>=300)throw new Error(`VCT URL returns error: ${e.status}`);let s;if((e.headers.get("content-type")||"").includes("application/json"))s=await e.json();else{const L=await e.text();try{s=JSON.parse(L)}catch{s={name:L}}}const w=s.name??s.description??s.vct??null;d.push(w)}}const k=d.length;let T=0;const a=Z(d.map(t=>({id:++T,name:t})),t=>t.name);async function u(){const t=D.value?.did??g.value[0]?.did??null;if(t!==null)try{await $fetch(`/wallet-api/wallet/${f.value}/exchange/useOfferRequest?did=${t}`,{method:"POST",body:{request:b}}),A(`/wallet/${f.value}`)}catch(e){m.value=!0;const s=e?.data??e;let n=s;if(typeof s=="string")if(s.trim().startsWith("{"))try{n=JSON.parse(s)}catch{n=s}else n=s;else typeof s=="object"&&s!==null?n=s:n=String(s);const w=n&&(n.message||n.error||n);throw y.value=typeof w=="string"?w:JSON.stringify(w),console.error("Error while accepting credential:",e),alert("Error occurred while trying to receive credential: "+y.value),e}}return{currentWallet:f,dids:g,selectedDid:D,pendingDids:c,acceptCredential:u,failed:m,failMessage:y,credentialTypes:d,credentialCount:k,groupedCredentialTypes:a,issuerHost:F}}const te={class:"mb-2 text-2xl text-center font-bold sm:mt-5 text-[#0F3F5E]"},se={key:1},re={class:"my-6 text-center"},ae={class:"text-red-500"},ne={class:"my-10"},le={key:0,class:"w-full flex justify-center mb-6"},oe={class:"w-full max-w-2xl px-4"},ie={key:2,class:"w-full flex justify-center gap-5"},de=["disabled"],ce=["disabled"],ue={key:3,class:"text-center text-[#627D98] mt-2"},fe={class:"sm:w-[80%] md:w-[60%] mx-auto"},pe={class:"text-[#0F3F5E] font-medium"},me={key:0,class:"text-sm text-[#627D98]"},we={key:0,class:"w-full sm:max-w-2xl sm:mx-auto"},ve={class:"fixed sm:relative bottom-0 w-full p-4 bg-white/95 border-t border-[#E4E7EB] shadow-md sm:shadow-none sm:flex sm:justify-end sm:gap-4"},$e=z({__name:"issuance",async setup($){let m,y;const f=R().query,g=C(!1),c=C(0),B=R().params.wallet,b=C(window.innerWidth<650),{acceptCredential:p,failed:_,failMessage:F,credentialTypes:E,issuerHost:h,credentialCount:d,groupedCredentialTypes:k}=([m,y]=P(()=>ee(f)),m=await m,y(),m);return f.accept&&(g.value=!0,p()),Q("Claim credentials - Credentis"),(T,a)=>(o(),i("div",null,[M(G,null,{default:q(()=>[l("h1",te," New "+x(r(d)===1?"Credential":"Credentials"),1),a[10]||(a[10]=l("p",{class:"text-center text-sm text-[#627D98] mb-6"}," Review the credential(s) offered before accepting. ",-1)),g.value?(o(),I(K,{key:0,class:"my-6 mb-12 w-full"},{default:q(()=>[H(" Receiving "+x(r(d))+" credential(s)... ",1)]),_:1})):v("",!0),r(_)?(o(),i("div",se,[l("div",re,[a[4]||(a[4]=l("h2",{class:"text-xl font-bold text-[#0F3F5E]"},"Failed to receive credential",-1)),l("p",ae,x(r(F)),1)])])):v("",!0),l("div",null,[l("div",ne,[r(f).view==="detail"||g.value?(o(),i("div",le,[l("div",oe,[M(S,{credential:{parsedDocument:{type:[r(E)[c.value]],issuer:{name:r(h)}}},isDetailView:!0},null,8,["credential"])])])):v("",!0),b.value?(o(!0),i(O,{key:1},N(r(k).keys(),(u,t)=>(o(),i("div",{key:u.id},[(o(!0),i(O,null,N(r(k).get(u),e=>(o(),i("div",{key:e,class:j([{"mt-[-85px]":t!==0},"col-span-1 divide-y divide-gray-200 rounded-2xl shadow transform hover:scale-105 cursor-pointer duration-200 w-full sm:w-[400px]"])},[M(S,{credential:{parsedDocument:{type:[e.name],issuer:{name:r(h)}}}},null,8,["credential"])],2))),128))]))),128)):(o(),i("div",ie,[r(d)>1?(o(),i("button",{key:0,onClick:a[0]||(a[0]=u=>c.value--),class:j(["mt-4 text-[#0F3F5E] font-bold bg-white",{"cursor-not-allowed opacity-50":c.value===0}]),disabled:c.value===0},[...a[5]||(a[5]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])],10,de)):v("",!0),(o(),I(S,{key:c.value,credential:{parsedDocument:{type:[r(E)[c.value]],issuer:{name:r(h)}}},class:"sm:w-[400px]"},null,8,["credential"])),r(d)>1?(o(),i("button",{key:1,onClick:a[1]||(a[1]=u=>c.value++),class:j(["mt-4 text-[#0F3F5E] font-bold bg-white",{"cursor-not-allowed opacity-50":c.value===r(d)-1}]),disabled:c.value===r(d)-1},[...a[6]||(a[6]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1)])],10,ce)):v("",!0)])),b.value?v("",!0):(o(),i("div",ue,x(c.value+1)+" of "+x(r(d)),1))]),l("div",fe,[a[8]||(a[8]=l("div",{class:"text-sm font-semibold text-[#0F3F5E]"},"Credential Offered",-1)),a[9]||(a[9]=l("hr",{class:"my-2 border-[#D0E6F3]"},null,-1)),(o(!0),i(O,null,N(r(k).keys(),(u,t)=>(o(),i("div",{key:u.id},[(o(!0),i(O,null,N(r(k).get(u),e=>(o(),i("div",{key:e},[l("div",pe,x(e.name),1),r(h)?(o(),i("div",me," from "+x(r(h)),1)):v("",!0),a[7]||(a[7]=l("hr",{class:"my-2 border-[#E4E7EB]"},null,-1))]))),128))]))),128))])])]),_:1}),r(_)?v("",!0):(o(),i("div",we,[l("div",ve,[l("button",{onClick:a[2]||(a[2]=(...u)=>r(p)&&r(p)(...u)),class:"w-full sm:w-44 py-3 mt-4 text-white rounded-xl shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all",style:{background:"linear-gradient(135deg, #2188CA, #0F3F5E)"}}," Accept "),l("button",{onClick:a[3]||(a[3]=u=>("navigateTo"in T?T.navigateTo:r(A))(`/wallet/${r(B)}`)),class:"w-full sm:w-44 py-3 mt-4 bg-white sm:border sm:border-[#CBD2D9] sm:rounded-xl text-[#0F3F5E] hover:bg-[#F0F4F8]"}," Decline ")])]))]))}});export{$e as default};
