import{j as F,P as U,Q as P,R as Q,S as R,T as z,n as W,i as H,k as I,f as G,q as K,c as i,b as j,B as x,w as A,h as r,a as o,t as b,o as l,g as J,d as X,F as O,r as N,A as q}from"#entry";import{c as Y}from"./eowDyVTy.js";import{C as Z}from"./BXf69NxL.js";import{L as ee}from"./BFiSVEsl.js";import{V}from"./BNt0v21H.js";import{u as te}from"./C7YCVWHz.js";import{d as se}from"./6yF6Fmpd.js";import{g as re}from"./_2w5uKZz.js";import"./dEyoA6Mq.js";import"./erPheUey.js";async function ae(T){const w=F(!1),_=F("Unknown error occurred."),c=te(),{data:k,pending:u}=await U(()=>$fetch(`/wallet-api/wallet/${c.value}/dids`),"$kvpLrQbSfp"),D=F(null);P(k,async e=>{await Q(),D.value=e?.find(t=>t.default==!0)??e?.[0]??null});async function B(e){try{return await $fetch(`/wallet-api/wallet/${c.value}/exchange/resolveCredentialOffer`,{method:"POST",body:{credential_offer_uri:e}})}catch(t){w.value=!0;let s="Failed to resolve credential offer";const n=t.data||t.response?._data;if(typeof n=="string")try{const h=JSON.parse(n);s=h.message||h.error||n}catch{s=n}else typeof n=="object"&&n!==null?s=n.message||n.error||JSON.stringify(n):t.message&&(s=t.message);throw _.value=s,console.error("[Issuance] Resolve offer failed:",s),t}}let C;try{if(!T||!T.request)throw new Error("No request provided");C=se(T.request)}catch(e){throw R({statusCode:400,statusMessage:`Invalid issuance request: ${e?.message||e}`})}const{data:p,error:E}=await z(`resolve-offer-${C}`,async()=>await B(C));if(E.value)throw R({statusCode:500,statusMessage:`Failed to resolve offer: ${E.value.message}`});if(d.value=p.value,p==null)throw R({statusCode:400,statusMessage:"Invalid issuance request: No credential_offer"});const $=p.credential_issuer;let v;try{v=new URL($).host}catch{v=$}const y=await $fetch(`/wallet-api/wallet/${c.value}/exchange/resolveIssuerOpenIDMetadata?issuer=${$}`),m=p.credential_configuration_ids?p.credential_configuration_ids.map(e=>y.credential_configurations_supported[e]):p.credentials.map(e=>y.credentials_supported?.find(t=>t.id===e)).filter(Boolean);let f=[];for(let e of m){if(typeof e.types<"u"){const t=e.types,s=t[t.length-1];f.push(s)}if(typeof e.credential_definition<"u"){const t=e.credential_definition.type,s=t[t.length-1];f.push(s)}if(typeof e.vct<"u"){const t=await fetch(`/wallet-api/wallet/${c.value}/exchange/resolveVctUrl?vct=${e.vct}`);if(t.status<200||t.status>=300)throw new Error(`VCT URL returns error: ${t.status}`);let s;if((t.headers.get("content-type")||"").includes("application/json"))s=await t.json();else{const M=await t.text();try{s=JSON.parse(M)}catch{s={name:M}}}const h=s.name??s.description??s.vct??null;f.push(h)}}const L=f.length;let g=0;const a=re(f.map(e=>({id:++g,name:e})),e=>e.name),d=F(null);async function S(){const e=D.value?.did??k.value[0]?.did??null;if(e!==null)try{await $fetch(`/wallet-api/wallet/${c.value}/exchange/useOfferRequest?did=${e}`,{method:"POST",body:{request:C,_credoResolved:d.value?._credoResolved}}),W(`/wallet/${c.value}`)}catch(t){w.value=!0;const s=t?.data??t;let n=s;if(typeof s=="string")if(s.trim().startsWith("{"))try{n=JSON.parse(s)}catch{n=s}else n=s;else typeof s=="object"&&s!==null?n=s:n=String(s);const h=n&&(n.message||n.error||n);throw _.value=typeof h=="string"?h:JSON.stringify(h),console.error("Error while accepting credential:",t),alert("Error occurred while trying to receive credential: "+_.value),t}}return{currentWallet:c,dids:k,selectedDid:D,pendingDids:u,acceptCredential:S,failed:w,failMessage:_,credentialTypes:f,credentialCount:L,groupedCredentialTypes:a,issuerHost:v}}const ne={class:"mb-2 text-2xl text-center font-bold sm:mt-5 text-[#0F3F5E]"},oe={key:1},le={class:"my-6 text-center"},ie={class:"text-red-500"},de={class:"my-10"},ue={key:0,class:"w-full flex justify-center mb-6"},ce={class:"w-full max-w-2xl px-4"},fe={key:2,class:"w-full flex justify-center gap-5"},pe=["disabled"],ve=["disabled"],me={key:3,class:"text-center text-[#627D98] mt-2"},we={class:"sm:w-[80%] md:w-[60%] mx-auto"},ye={class:"text-[#0F3F5E] font-medium"},ge={key:0,class:"text-sm text-[#627D98]"},he={key:0,class:"w-full sm:max-w-2xl sm:mx-auto"},xe={class:"fixed sm:relative bottom-0 w-full p-4 bg-white/95 border-t border-[#E4E7EB] shadow-md sm:shadow-none sm:flex sm:justify-end sm:gap-4"},Oe=H({__name:"issuance",async setup(T){let w,_;const c=I().query,k=F(!1),u=F(0),B=I().params.wallet,C=F(window.innerWidth<650),{acceptCredential:p,failed:E,failMessage:$,credentialTypes:v,issuerHost:y,credentialCount:m,groupedCredentialTypes:f}=([w,_]=G(()=>ae(c)),w=await w,_(),w),L=K(()=>{if(!v.value||v.value.length===0)return"Save";const g=v.value[0]?.toLowerCase()||"";return g.includes("receipt")?"Save Receipt":g.includes("invoice")?"Save Invoice":g.includes("quote")?"Save Quote":"Save"});return c.accept&&(k.value=!0,p()),Y("Save to Wallet - Credentis"),(g,a)=>(l(),i("div",null,[j(Z,null,{default:A(()=>[o("h1",ne," New "+b(r(m)===1?"Credential":"Credentials"),1),a[10]||(a[10]=o("p",{class:"text-center text-sm text-[#627D98] mb-6"}," Review the credential(s) offered before accepting. ",-1)),k.value?(l(),J(ee,{key:0,class:"my-6 mb-12 w-full"},{default:A(()=>[X(" Receiving "+b(r(m))+" credential(s)... ",1)]),_:1})):x("",!0),r(E)?(l(),i("div",oe,[o("div",le,[a[4]||(a[4]=o("h2",{class:"text-xl font-bold text-[#0F3F5E]"},"Failed to receive credential",-1)),o("p",ie,b(r($)),1)])])):x("",!0),o("div",null,[o("div",de,[r(c).view==="detail"||k.value?(l(),i("div",ue,[o("div",ce,[j(V,{credential:{parsedDocument:{type:[r(v)[u.value]],issuer:{name:r(y)}}},isDetailView:!0},null,8,["credential"])])])):x("",!0),C.value?(l(!0),i(O,{key:1},N(r(f).keys(),(d,S)=>(l(),i("div",{key:d.id},[(l(!0),i(O,null,N(r(f).get(d),e=>(l(),i("div",{key:e,class:q([{"mt-[-85px]":S!==0},"col-span-1 divide-y divide-gray-200 rounded-2xl shadow transform hover:scale-105 cursor-pointer duration-200 w-full sm:w-[400px]"])},[j(V,{credential:{parsedDocument:{type:[e.name],issuer:{name:r(y)}}}},null,8,["credential"])],2))),128))]))),128)):(l(),i("div",fe,[r(m)>1?(l(),i("button",{key:0,onClick:a[0]||(a[0]=d=>u.value--),class:q(["mt-4 text-[#0F3F5E] font-bold bg-white",{"cursor-not-allowed opacity-50":u.value===0}]),disabled:u.value===0},[...a[5]||(a[5]=[o("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])],10,pe)):x("",!0),(l(),J(V,{key:u.value,credential:{parsedDocument:{type:[r(v)[u.value]],issuer:{name:r(y)}}},class:"sm:w-[400px]"},null,8,["credential"])),r(m)>1?(l(),i("button",{key:1,onClick:a[1]||(a[1]=d=>u.value++),class:q(["mt-4 text-[#0F3F5E] font-bold bg-white",{"cursor-not-allowed opacity-50":u.value===r(m)-1}]),disabled:u.value===r(m)-1},[...a[6]||(a[6]=[o("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1)])],10,ve)):x("",!0)])),C.value?x("",!0):(l(),i("div",me,b(u.value+1)+" of "+b(r(m)),1))]),o("div",we,[a[8]||(a[8]=o("div",{class:"text-sm font-semibold text-[#0F3F5E]"},"Credential Offered",-1)),a[9]||(a[9]=o("hr",{class:"my-2 border-[#D0E6F3]"},null,-1)),(l(!0),i(O,null,N(r(f).keys(),(d,S)=>(l(),i("div",{key:d.id},[(l(!0),i(O,null,N(r(f).get(d),e=>(l(),i("div",{key:e},[o("div",ye,b(e.name),1),r(y)?(l(),i("div",ge," from "+b(r(y)),1)):x("",!0),a[7]||(a[7]=o("hr",{class:"my-2 border-[#E4E7EB]"},null,-1))]))),128))]))),128))])])]),_:1}),r(E)?x("",!0):(l(),i("div",he,[o("div",xe,[o("button",{onClick:a[2]||(a[2]=(...d)=>r(p)&&r(p)(...d)),class:"w-full sm:w-44 py-3 mt-4 text-white rounded-xl shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all",style:{background:"linear-gradient(135deg, #2188CA, #0F3F5E)"}},b(L.value),1),o("button",{onClick:a[3]||(a[3]=d=>("navigateTo"in g?g.navigateTo:r(W))(`/wallet/${r(B)}`)),class:"w-full sm:w-44 py-3 mt-4 bg-white sm:border sm:border-[#CBD2D9] sm:rounded-xl text-[#0F3F5E] hover:bg-[#F0F4F8]"}," Not Now ")])]))]))}});export{Oe as default};
