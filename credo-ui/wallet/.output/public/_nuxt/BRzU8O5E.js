import{l as C,P as F,Q as U,R as W,S as q,j as A,k as P,m as B,i as z,c as i,b as E,h as v,w as I,g as r,a as l,o,e as R,t as g,d as H,F as M,r as S,n as j}from"#entry";import{d as Q}from"./D75GOWRg.js";import{C as G}from"./B-1inGnY.js";import{L as K}from"./Dhsf9hJ5.js";import{V as J}from"./ChWA9fIA.js";import{u as X}from"./CS6oTbIc.js";import{d as Y}from"./6yF6Fmpd.js";import{g as Z}from"./_2w5uKZz.js";import"./D-q_bWm-.js";async function ee(T){const m=C(!1),y=C("Unknown error occurred."),f=X(),{data:h,pending:u}=await F(()=>$fetch(`/wallet-api/wallet/${f.value}/dids`),"$kvpLrQbSfp"),O=C(null);U(h,async t=>{await W(),O.value=t?.find(e=>e.default==!0)??t?.[0]??null});async function D(t){try{return await $fetch(`/wallet-api/wallet/${f.value}/exchange/resolveCredentialOffer`,{method:"POST",body:{credential_offer_uri:t}})}catch(e){m.value=!0;let s="Failed to resolve credential offer";const n=e.data||e.response?._data;if(typeof n=="string")try{const w=JSON.parse(n);s=w.message||w.error||n}catch{s=n}else typeof n=="object"&&n!==null?s=n.message||n.error||JSON.stringify(n):e.message&&(s=e.message);throw y.value=s,console.error("[Issuance] Resolve offer failed:",s),e}}let x;try{if(!T||!T.request)throw new Error("No request provided");x=Y(T.request)}catch(t){throw q({statusCode:400,statusMessage:`Invalid issuance request: ${t?.message||t}`})}const p=await D(x);if(p==null)throw q({statusCode:400,statusMessage:"Invalid issuance request: No credential_offer"});const k=p.credential_issuer;let $;try{$=new URL(k).host}catch{$=k}const N=await $fetch(`/wallet-api/wallet/${f.value}/exchange/resolveIssuerOpenIDMetadata?issuer=${k}`),_=p.credential_configuration_ids?p.credential_configuration_ids.map(t=>N.credential_configurations_supported[t]):p.credentials.map(t=>N.credentials_supported?.find(e=>e.id===t)).filter(Boolean);let d=[];for(let t of _){if(typeof t.types<"u"){const e=t.types,s=e[e.length-1];d.push(s)}if(typeof t.credential_definition<"u"){const e=t.credential_definition.type,s=e[e.length-1];d.push(s)}if(typeof t.vct<"u"){const e=await fetch(`/wallet-api/wallet/${f.value}/exchange/resolveVctUrl?vct=${t.vct}`);if(e.status<200||e.status>=300)throw new Error(`VCT URL returns error: ${e.status}`);let s;if((e.headers.get("content-type")||"").includes("application/json"))s=await e.json();else{const V=await e.text();try{s=JSON.parse(V)}catch{s={name:V}}}const w=s.name??s.description??s.vct??null;d.push(w)}}const b=d.length;let L=0;const a=Z(d.map(t=>({id:++L,name:t})),t=>t.name);async function c(){const t=O.value?.did??h.value[0]?.did??null;if(t!==null)try{await $fetch(`/wallet-api/wallet/${f.value}/exchange/useOfferRequest?did=${t}`,{method:"POST",body:{request:x}}),A(`/wallet/${f.value}`)}catch(e){m.value=!0;const s=e?.data??e;let n=s;if(typeof s=="string")if(s.trim().startsWith("{"))try{n=JSON.parse(s)}catch{n=s}else n=s;else typeof s=="object"&&s!==null?n=s:n=String(s);const w=n&&(n.message||n.error||n);throw y.value=typeof w=="string"?w:JSON.stringify(w),console.error("Error while accepting credential:",e),alert("Error occurred while trying to receive credential: "+y.value),e}}return{currentWallet:f,dids:h,selectedDid:O,pendingDids:u,acceptCredential:c,failed:m,failMessage:y,credentialTypes:d,credentialCount:b,groupedCredentialTypes:a,issuerHost:$}}const te={class:"mb-2 text-2xl text-center font-bold sm:mt-5"},se={key:1},re={class:"my-6 text-center"},ae={class:"text-red-500"},ne={class:"my-10"},le={key:1,class:"w-full flex justify-center gap-5"},oe=["disabled"],ie=["disabled"],de={key:2,class:"text-center text-gray-500 mt-2"},ce={class:"sm:w-[80%] md:w-[60%] mx-auto"},ue={class:"text-black-800"},fe={key:0,class:"text-sm text-gray-400"},pe={key:0,class:"w-full sm:max-w-2xl sm:mx-auto"},me={class:"fixed sm:relative bottom-0 w-full p-4 bg-white shadow-md sm:shadow-none sm:flex sm:justify-end sm:gap-4"},Ce=P({__name:"issuance",async setup(T){let m,y;const f=B().query,h=C(!1),u=C(0),D=B().params.wallet,x=C(window.innerWidth<650),{acceptCredential:p,failed:k,failMessage:$,credentialTypes:N,issuerHost:_,credentialCount:d,groupedCredentialTypes:b}=([m,y]=z(()=>ee(f)),m=await m,y(),m);return f.accept&&(h.value=!0,p()),Q("Claim credentials - Credentis"),(L,a)=>(o(),i("div",null,[E(G,null,{default:I(()=>[l("h1",te," New "+g(r(d)===1?"Credential":"Credentials"),1),h.value?(o(),R(K,{key:0,class:"my-6 mb-12 w-full"},{default:I(()=>[H(" Receiving "+g(r(d))+" credential(s)... ",1)]),_:1})):v("",!0),r(k)?(o(),i("div",se,[l("div",re,[a[4]||(a[4]=l("h2",{class:"text-xl font-bold"},"Failed to receive credential",-1)),l("p",ae,g(r($)),1)])])):v("",!0),l("div",null,[l("div",ne,[x.value?(o(!0),i(M,{key:0},S(r(b).keys(),(c,t)=>(o(),i("div",{key:c.id},[(o(!0),i(M,null,S(r(b).get(c),e=>(o(),i("div",{key:e,class:j([{"mt-[-85px]":t!==0},"col-span-1 divide-y divide-gray-200 rounded-2xl shadow transform hover:scale-105 cursor-pointer duration-200 w-full sm:w-[400px]"])},[E(J,{credential:{parsedDocument:{type:[e.name],issuer:{name:r(_)}}},isDetailView:!0},null,8,["credential"])],2))),128))]))),128)):(o(),i("div",le,[r(d)>1?(o(),i("button",{key:0,onClick:a[0]||(a[0]=c=>u.value--),class:j(["mt-4 text-[#002159] font-bold bg-white",{"cursor-not-allowed opacity-50":u.value===0}]),disabled:u.value===0},[...a[5]||(a[5]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])],10,oe)):v("",!0),(o(),R(J,{key:u.value,credential:{parsedDocument:{type:[r(N)[u.value]],issuer:{name:r(_)}}},class:"sm:w-[400px]"},null,8,["credential"])),r(d)>1?(o(),i("button",{key:1,onClick:a[1]||(a[1]=c=>u.value++),class:j(["mt-4 text-[#002159] font-bold bg-white",{"cursor-not-allowed opacity-50":u.value===r(d)-1}]),disabled:u.value===r(d)-1},[...a[6]||(a[6]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1)])],10,ie)):v("",!0)])),x.value?v("",!0):(o(),i("div",de,g(u.value+1)+" of "+g(r(d)),1))]),l("div",ce,[a[8]||(a[8]=l("div",{class:"text-sm font-bold text-gray-500"},"Credential Offered",-1)),a[9]||(a[9]=l("hr",{class:"my-2 border-gray-200"},null,-1)),(o(!0),i(M,null,S(r(b).keys(),(c,t)=>(o(),i("div",{key:c.id},[(o(!0),i(M,null,S(r(b).get(c),e=>(o(),i("div",{key:e},[l("div",ue,g(e.name),1),r(_)?(o(),i("div",fe," from "+g(r(_)),1)):v("",!0),a[7]||(a[7]=l("hr",{class:"my-2 border-gray-200"},null,-1))]))),128))]))),128))])])]),_:1}),r(k)?v("",!0):(o(),i("div",pe,[l("div",me,[l("button",{onClick:a[2]||(a[2]=(...c)=>r(p)&&r(p)(...c)),class:"w-full sm:w-44 py-3 mt-4 text-white bg-[#002159] rounded-xl"}," Accept "),l("button",{onClick:a[3]||(a[3]=c=>("navigateTo"in L?L.navigateTo:r(A))(`/wallet/${r(D)}`)),class:"w-full sm:w-44 py-3 mt-4 bg-white sm:border sm:border-gray-400 sm:rounded-xl"}," Decline ")])]))]))}});export{Ce as default};
