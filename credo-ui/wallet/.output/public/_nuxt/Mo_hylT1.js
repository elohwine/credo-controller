import H from"./fvw6v6Xq.js";import{p as N,a as I,e as K,_ as J}from"./BCLalOk0.js";import{k as V,x as j,c as r,o,F as L,a as l,n as M,h as S,d as E,t as k,g as e,r as A,l as p,M as Y,j as F,m as Z,i as G,b as U,w as W,e as z}from"#entry";import{c as Q}from"./Drjdh8M5.js";import{C as X}from"./CGoOfd1o.js";import{u as _}from"./CbphGzgi.js";import{d as ee}from"./6yF6Fmpd.js";import{L as te}from"./_ObbXfpD.js";const se={class:"sm:flex justify-between items-center"},ie={key:0,width:"16",height:"16",viewBox:"0 0 17 10",fill:"none",xmlns:"http://www.w3.org/2000/svg"},le={key:1,width:"16",height:"16",viewBox:"0 0 10 18",fill:"none",xmlns:"http://www.w3.org/2000/svg"},ne={key:0,class:"flex items-center gap-2"},oe=["disabled","checked"],re={key:1},ae={key:0},de={class:"mt-1 divide-y px-10 divide-gray-100"},ce={class:"min-w-0 flex-1 text-sm leading-6"},ue=["for"],me={class:"ml-3 flex h-6 items-center"},ve=["id","name","disabled","checked","onClick"],fe=V({__name:"CredentialDisclosure",props:{credential:{},disclosures:{},selection:{},disclosureModalState:{},toggleDisclosure:{type:Function},addDisclosure:{type:Function},removeDisclosure:{type:Function}},setup(t){const u=t,b=j(()=>{const D=u.credential.parsedDocument??N(u.credential.document).vc??N(u.credential.document);return D?.type?.at(-1)??D.vct.split("/").pop()??"Unknown"}),w=j(()=>b.value.replace(/([a-z0-9])([A-Z])/g,"$1 $2")),m=j(()=>I(u.credential.disclosures||""));return(D,c)=>(o(),r(L,null,[t.credential.disclosures?(o(),r("div",{key:0,class:M(["w-full",{"text-[#7B8794]":!t.selection[t.credential.id]}])},[l("div",se,[l("div",{onClick:c[0]||(c[0]=f=>t.toggleDisclosure(t.credential.id)),class:M([{"font-semibold":t.disclosureModalState[t.credential.id]&&t.selection[t.credential.id],"text-black-800":t.selection[t.credential.id]},"flex gap-3 items-center cursor-pointer"])},[E(k(e(w))+" ",1),t.disclosureModalState[t.credential.id]?(o(),r("svg",ie,[...c[2]||(c[2]=[l("path",{d:"M16 1L8.5 8.5L1 1",stroke:"black","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)])])):(o(),r("svg",le,[...c[3]||(c[3]=[l("path",{d:"M1.25 1.5L8.75 9L1.25 16.5",stroke:"#323F4B","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)])]))],2),l("div",null,[t.disclosureModalState[t.credential.id]?(o(),r("div",ne,[c[4]||(c[4]=E(" Disclose All ",-1)),l("input",{type:"checkbox",disabled:!t.selection[t.credential.id],class:"h-4 w-4 rounded border-gray-300 text-primary-400 focus:ring-primary-500",onClick:c[1]||(c[1]=f=>t.disclosures[t.credential.id]=f.target?.checked?e(m):[]),checked:t.disclosures[t.credential.id]?.length===e(m)?.length},null,8,oe)])):(o(),r("div",re,k(t.disclosures[t.credential.id]===void 0?`Disclosing 0 of ${e(m).length} attributes`:t.disclosures[t.credential.id]?.length===e(m).length?"Disclosing all attributes":`Disclosing ${t.disclosures[t.credential.id].length} of ${e(m).length} attributes`),1))])]),t.disclosureModalState[t.credential.id]?(o(),r("div",ae,[c[5]||(c[5]=l("div",{class:"flex items-center mt-1"},[l("div",{class:"flex-1 border-t border-gray-300"}),l("div",{class:"mx-3 text-gray-400"},"Attributes to disclose"),l("div",{class:"flex-1 border-t border-gray-300"})],-1)),l("div",de,[(o(!0),r(L,null,A(e(m),(f,$)=>(o(),r("div",{key:$,class:"relative flex items-start py-1"},[l("div",ce,[l("label",{for:`disclosure-${t.credential.id}-${f[0]}`},[l("span",{class:M({"text-black-800":t.selection[t.credential.id]})},k(f[1].charAt(0).toUpperCase()+f[1].slice(1)),3)],8,ue)]),l("div",me,[l("input",{id:`disclosure-${t.credential.id}-${f[0]}`,name:`disclosure-${f[0]}`,class:"h-4 w-4 rounded border-gray-300 text-primary-400 focus:ring-primary-500",type:"checkbox",disabled:!t.selection[t.credential.id],checked:t.disclosures[t.credential.id]&&t.disclosures[t.credential.id].find(h=>h[0]===f[0]),onClick:h=>h.target?.checked?t.addDisclosure(t.credential.id,f):t.removeDisclosure(t.credential.id,f)},null,8,ve)])]))),128))])])):S("",!0)],2)):(o(),r("div",{key:1,class:M({"text-black-800":t.selection[t.credential.id],"text-[#7B8794]":!t.selection[t.credential.id]})},k(e(w)),3)),c[6]||(c[6]=l("hr",{class:"my-2 border-gray-200"},null,-1))],64))}});async function ge(t){const u=p(0),b=p(!1),w=p("Unknown error occurred."),m=_();async function D(s){try{return await $fetch(`/wallet-api/wallet/${m.value}/exchange/resolvePresentationRequest`,{method:"POST",body:s})}catch(a){b.value=!0;const i=a?.data?.message||a?.data?.details||a?.message||"Failed to resolve presentation request";throw w.value=i,console.error("[Presentation] Resolve request failed:",i),a}}const c=await D(ee(t.request)),$=new URL(c).searchParams,h=new URL($.get("response_uri")??$.get("redirect_uri")??"").host,q=$.get("presentation_definition"),x=await $fetch(`/wallet-api/wallet/${m.value}/exchange/matchCredentialsForPresentationDefinition`,{method:"POST",body:q}),P=p({}),B=j(()=>Object.entries(P.value).filter(s=>s[1]).map(s=>s[0]));for(let s of x)P.value[s.id]=!0;const d=p({}),y=j(()=>{if(JSON.stringify(d.value)==="{}")return null;const s={};for(let a in d.value){s[a]===void 0&&(s[a]=[]);for(let i of d.value[a])s[a].push(K(i))}return s});function R(s,a){d.value[s]===void 0&&(d.value[s]=[]),d.value[s].push(a)}function O(s,a){d.value[s]=d.value[s].filter(i=>i[0]!=a[0])}const v=p({});for(let s of x)v.value[s.id]=!1;x[u.value]&&(v.value[x[u.value].id]=!0);function g(s){v.value[s]=!v.value[s]}Y(u,()=>{for(let s of x)v.value[s.id]=!1;v.value[x[u.value].id]=!0});async function n(){const s={presentationRequest:c,selectedCredentials:B.value,disclosures:y.value},a=await fetch(`/wallet-api/wallet/${m.value}/exchange/usePresentationRequest`,{method:"POST",body:JSON.stringify(s),redirect:"manual",headers:{"Content-Type":"application/json"}});if(a.ok){const i=await a.json();i.redirectUri?F(i.redirectUri,{external:!0}):(window.alert("Presentation successful, no redirect URL supplied."),F(`/wallet/${m.value}`,{external:!0}))}else{b.value=!0;const i=await a.json();w.value=i.message||i.errorMessage||"Presentation failed",console.error("[Presentation] Accept failed:",w.value),w.value=i.message,console.log("Error response: "+JSON.stringify(i)),window.alert(i.errorMessage),i.redirectUri!=null&&F(i.redirectUri,{external:!0})}}return{currentWallet:m,verifierHost:h,presentationDefinition:q,matchedCredentials:x,selectedCredentialIds:B,disclosures:d,selection:P,index:u,disclosureModalState:v,toggleDisclosure:g,addDisclosure:R,removeDisclosure:O,acceptPresentation:n,failed:b,failMessage:w}}const he={key:1},we={class:"text-red-600 animate-pulse flex items-center gap-1 py-1"},ye={key:2,class:"my-10 mb-40 sm:mb-10 overflow-scroll"},xe={key:1,class:"w-full flex justify-center gap-5"},ke=["disabled"],be=["disabled"],De={key:2,class:"text-center text-gray-500 mt-2"},$e={class:"sm:w-[80%] md:w-[60%] mx-auto"},pe={class:"text-gray-500 mt-8 sm:mt-0"},Ce={key:0,class:"border border-[#E4E7EB] rounded-xl p-4 mb-4"},Me={class:"text-[#616E7C]"},Pe={class:"mt-2 flex gap-2"},Se=["id","checked","onClick"],je={key:1},qe={key:0,class:"w-full sm:max-w-2xl sm:mx-auto"},Be={class:"fixed sm:relative bottom-0 w-full p-4 bg-white shadow-md sm:shadow-none sm:flex sm:justify-end sm:gap-4"},Je=V({__name:"presentation",async setup(t){let u,b;const w=p(!1),m=p(window.innerWidth<650),D=Z(),c=D.query,f=D.params.wallet,{disclosures:$,selection:h,disclosureModalState:q,toggleDisclosure:x,addDisclosure:P,removeDisclosure:B,matchedCredentials:d,index:y,acceptPresentation:R,failed:O}=([u,b]=G(()=>ge(c)),u=await u,b(),u),v=j(()=>{const g={};for(const n of d){const s=N(n.document),a=(n.parsedDocument??s.vc??s).type??s.vct?[s.vct]:void 0,i=Array.isArray(a)&&a.length>0?a.at(-1):"unknown";g[i]||(g[i]=[]),g[i].push(n)}return g});return Y(v,g=>{for(const n in g)if(g[n].length>1){for(const s of g[n])h.value[s.id]=!1;h.value[g[n][0].id]=!0}},{immediate:!0}),c.accept&&(w.value=!0,R()),Q("Present credentials - IdenEx"),(g,n)=>{const s=H,a=fe;return o(),r("div",null,[U(X,null,{default:W(()=>[n[9]||(n[9]=l("h1",{class:"mb-2 text-2xl text-center font-bold"},"Presentation Request",-1)),e(w)?(o(),z(te,{key:0,class:"my-6 mb-12 w-full"},{default:W(()=>[...n[4]||(n[4]=[E(" Presenting credential(s)... ",-1)])]),_:1})):S("",!0),e(d).length==0?(o(),r("div",he,[l("span",we,[U(s,{name:"heroicons:exclamation-circle",class:"h-6 w-6"}),n[5]||(n[5]=E(" You don't have any credentials matching this presentation definition in your wallet. ",-1))])])):(o(),r("div",ye,[e(m)?(o(!0),r(L,{key:0},A(e(d),(i,C)=>(o(),r("div",{key:C},[l("div",{class:M([{"mt-[-85px]":C!==0},"col-span-1 divide-y divide-gray-200 rounded-2xl bg-white shadow transform hover:scale-105 cursor-pointer duration-200"])},[U(J,{credential:i},null,8,["credential"])],2)]))),128)):(o(),r("div",xe,[e(d).length>1?(o(),r("button",{key:0,onClick:n[0]||(n[0]=i=>y.value--),class:M(["mt-4 text-[#002159] font-bold bg-white",{"cursor-not-allowed opacity-50":e(y)===0}]),disabled:e(y)===0},[...n[6]||(n[6]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])],10,ke)):S("",!0),(o(),z(J,{key:e(y),credential:{document:e(d)[e(y)].document},class:"sm:w-[400px]"},null,8,["credential"])),e(d).length>1?(o(),r("button",{key:1,onClick:n[1]||(n[1]=i=>y.value++),class:M(["mt-4 text-[#002159] font-bold bg-white",{"cursor-not-allowed opacity-50":e(y)===e(d).length-1}]),disabled:e(y)===e(d).length-1},[...n[7]||(n[7]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1)])],10,be)):S("",!0)])),e(m)?S("",!0):(o(),r("div",De,k(e(y)+1)+" of "+k(e(d).length),1)),l("div",$e,[l("div",pe,k(e(d).length>1?"Credentials":"Credential")+" to present ",1),n[8]||(n[8]=l("hr",{class:"mt-1 mb-2 border-gray-200"},null,-1)),(o(!0),r(L,null,A(Object.keys(e(v)),i=>(o(),r("div",null,[e(v)[i].length>1?(o(),r("div",Ce,[l("div",Me," You have "+k(e(v)[i].length)+" matching credentials of the same type; please choose one. ",1),(o(!0),r(L,null,A(e(v)[i],C=>(o(),r("div",Pe,[l("input",{type:"radio",id:`${i}-grouped-credential-${C.id}`,checked:e(h)[C.id],onClick:Re=>e(v)[i].forEach(T=>e(h)[T.id]=T.id===C.id),class:"mt-1 h-4 w-4 text-[#0573F0]"},null,8,Se),U(a,{credential:C,disclosureModalState:e(q),disclosures:e($),selection:e(h),toggleDisclosure:e(x),addDisclosure:e(P),removeDisclosure:e(B)},null,8,["credential","disclosureModalState","disclosures","selection","toggleDisclosure","addDisclosure","removeDisclosure"])]))),256))])):(o(),r("div",je,[U(a,{credential:e(v)[i][0],disclosureModalState:e(q),disclosures:e($),selection:e(h),toggleDisclosure:e(x),addDisclosure:e(P),removeDisclosure:e(B)},null,8,["credential","disclosureModalState","disclosures","selection","toggleDisclosure","addDisclosure","removeDisclosure"])]))]))),256))])]))]),_:1}),!e(O)&&e(d).length?(o(),r("div",qe,[l("div",Be,[l("button",{onClick:n[2]||(n[2]=(...i)=>e(R)&&e(R)(...i)),class:"w-full sm:w-44 py-3 mt-4 text-white bg-[#002159] rounded-xl"},k(e(d).length>1?"Disclose All":"Disclose"),1),l("button",{onClick:n[3]||(n[3]=i=>("navigateTo"in g?g.navigateTo:e(F))(`/wallet/${e(f)}`)),class:"w-full sm:w-44 py-3 mt-4 bg-white sm:border sm:border-gray-400 sm:rounded-xl"}," Decline ")])])):S("",!0)])}}});export{Je as default};
