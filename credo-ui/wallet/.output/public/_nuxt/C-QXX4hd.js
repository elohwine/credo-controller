import{l as C,L as F,M as U,N as W,O as I,j as A,k as z,m as q,i as H,c as i,b as B,h as v,w as V,g as a,a as l,o,e as R,t as g,d as P,F as M,r as D,n as E}from"#entry";import{c as Q}from"./Drjdh8M5.js";import{C as G}from"./CGoOfd1o.js";import{L as K}from"./_ObbXfpD.js";import{_ as J}from"./BCLalOk0.js";import{u as X}from"./CbphGzgi.js";import{d as Y}from"./6yF6Fmpd.js";import{g as Z}from"./_2w5uKZz.js";async function ee(T){const m=C(!1),y=C("Unknown error occurred."),f=X(),{data:h,pending:u}=await F(()=>$fetch(`/wallet-api/wallet/${f.value}/dids`),"$kvpLrQbSfp"),O=C(null);U(h,async t=>{await W(),O.value=t?.find(e=>e.default==!0)??t?.[0]??null});async function S(t){try{return await $fetch(`/wallet-api/wallet/${f.value}/exchange/resolveCredentialOffer`,{method:"POST",body:{credential_offer_uri:t}})}catch(e){m.value=!0;let s="Failed to resolve credential offer";const n=e.data||e.response?._data;if(typeof n=="string")try{const w=JSON.parse(n);s=w.message||w.error||n}catch{s=n}else typeof n=="object"&&n!==null?s=n.message||n.error||JSON.stringify(n):e.message&&(s=e.message);throw y.value=s,console.error("[Issuance] Resolve offer failed:",s),e}}let x;try{if(!T||!T.request)throw new Error("No request provided");x=Y(T.request)}catch(t){throw I({statusCode:400,statusMessage:`Invalid issuance request: ${t?.message||t}`})}const p=await S(x);if(p==null)throw I({statusCode:400,statusMessage:"Invalid issuance request: No credential_offer"});const _=p.credential_issuer;let $;try{$=new URL(_).host}catch{$=_}const N=await $fetch(`/wallet-api/wallet/${f.value}/exchange/resolveIssuerOpenIDMetadata?issuer=${_}`),k=p.credential_configuration_ids?p.credential_configuration_ids.map(t=>N.credential_configurations_supported[t]):p.credentials.map(t=>N.credentials_supported?.find(e=>e.id===t)).filter(Boolean);let d=[];for(let t of k){if(typeof t.types<"u"){const e=t.types,s=e[e.length-1];d.push(s)}if(typeof t.credential_definition<"u"){const e=t.credential_definition.type,s=e[e.length-1];d.push(s)}if(typeof t.vct<"u"){const e=await fetch(`/wallet-api/wallet/${f.value}/exchange/resolveVctUrl?vct=${t.vct}`);if(e.status<200||e.status>=300)throw new Error(`VCT URL returns error: ${e.status}`);let s;if((e.headers.get("content-type")||"").includes("application/json"))s=await e.json();else{const j=await e.text();try{s=JSON.parse(j)}catch{s={name:j}}}const w=s.name??s.description??s.vct??null;d.push(w)}}const b=d.length;let L=0;const r=Z(d.map(t=>({id:++L,name:t})),t=>t.name);async function c(){const t=O.value?.did??h.value[0]?.did??null;if(t!==null)try{await $fetch(`/wallet-api/wallet/${f.value}/exchange/useOfferRequest?did=${t}`,{method:"POST",body:{request:x}}),A(`/wallet/${f.value}`)}catch(e){m.value=!0;const s=e?.data??e;let n=s;if(typeof s=="string")if(s.trim().startsWith("{"))try{n=JSON.parse(s)}catch{n=s}else n=s;else typeof s=="object"&&s!==null?n=s:n=String(s);const w=n&&(n.message||n.error||n);throw y.value=typeof w=="string"?w:JSON.stringify(w),console.error("Error while accepting credential:",e),alert("Error occurred while trying to receive credential: "+y.value),e}}return{currentWallet:f,dids:h,selectedDid:O,pendingDids:u,acceptCredential:c,failed:m,failMessage:y,credentialTypes:d,credentialCount:b,groupedCredentialTypes:r,issuerHost:$}}const te={class:"mb-2 text-2xl text-center font-bold sm:mt-5"},se={key:1},ae={class:"my-6 text-center"},re={class:"text-red-500"},ne={class:"my-10"},le={key:1,class:"w-full flex justify-center gap-5"},oe=["disabled"],ie=["disabled"],de={key:2,class:"text-center text-gray-500 mt-2"},ce={class:"sm:w-[80%] md:w-[60%] mx-auto"},ue={class:"text-black-800"},fe={key:0,class:"text-sm text-gray-400"},pe={key:0,class:"w-full sm:max-w-2xl sm:mx-auto"},me={class:"fixed sm:relative bottom-0 w-full p-4 bg-white shadow-md sm:shadow-none sm:flex sm:justify-end sm:gap-4"},be=z({__name:"issuance",async setup(T){let m,y;const f=q().query,h=C(!1),u=C(0),S=q().params.wallet,x=C(window.innerWidth<650),{acceptCredential:p,failed:_,failMessage:$,credentialTypes:N,issuerHost:k,credentialCount:d,groupedCredentialTypes:b}=([m,y]=H(()=>ee(f)),m=await m,y(),m);return f.accept&&(h.value=!0,p()),Q("Claim credentials - IdenEx"),(L,r)=>(o(),i("div",null,[B(G,null,{default:V(()=>[l("h1",te," New "+g(a(d)===1?"Credential":"Credentials"),1),h.value?(o(),R(K,{key:0,class:"my-6 mb-12 w-full"},{default:V(()=>[P(" Receiving "+g(a(d))+" credential(s)... ",1)]),_:1})):v("",!0),a(_)?(o(),i("div",se,[l("div",ae,[r[4]||(r[4]=l("h2",{class:"text-xl font-bold"},"Failed to receive credential",-1)),l("p",re,g(a($)),1)])])):v("",!0),l("div",null,[l("div",ne,[x.value?(o(!0),i(M,{key:0},D(a(b).keys(),(c,t)=>(o(),i("div",{key:c.id},[(o(!0),i(M,null,D(a(b).get(c),e=>(o(),i("div",{key:e,class:E([{"mt-[-85px]":t!==0},"col-span-1 divide-y divide-gray-200 rounded-2xl bg-white shadow transform hover:scale-105 cursor-pointer duration-200 w-full sm:w-[400px]"])},[B(J,{credential:{parsedDocument:{type:[e.name],issuer:{name:a(k)}}},isDetailView:!0},null,8,["credential"])],2))),128))]))),128)):(o(),i("div",le,[a(d)>1?(o(),i("button",{key:0,onClick:r[0]||(r[0]=c=>u.value--),class:E(["mt-4 text-[#002159] font-bold bg-white",{"cursor-not-allowed opacity-50":u.value===0}]),disabled:u.value===0},[...r[5]||(r[5]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])],10,oe)):v("",!0),(o(),R(J,{key:u.value,credential:{parsedDocument:{type:[a(N)[u.value]],issuer:{name:a(k)}}},class:"sm:w-[400px]"},null,8,["credential"])),a(d)>1?(o(),i("button",{key:1,onClick:r[1]||(r[1]=c=>u.value++),class:E(["mt-4 text-[#002159] font-bold bg-white",{"cursor-not-allowed opacity-50":u.value===a(d)-1}]),disabled:u.value===a(d)-1},[...r[6]||(r[6]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1)])],10,ie)):v("",!0)])),x.value?v("",!0):(o(),i("div",de,g(u.value+1)+" of "+g(a(d)),1))]),l("div",ce,[r[8]||(r[8]=l("div",{class:"text-sm font-bold text-gray-500"},"Credential Offered",-1)),r[9]||(r[9]=l("hr",{class:"my-2 border-gray-200"},null,-1)),(o(!0),i(M,null,D(a(b).keys(),(c,t)=>(o(),i("div",{key:c.id},[(o(!0),i(M,null,D(a(b).get(c),e=>(o(),i("div",{key:e},[l("div",ue,g(e.name),1),a(k)?(o(),i("div",fe," from "+g(a(k)),1)):v("",!0),r[7]||(r[7]=l("hr",{class:"my-2 border-gray-200"},null,-1))]))),128))]))),128))])])]),_:1}),a(_)?v("",!0):(o(),i("div",pe,[l("div",me,[l("button",{onClick:r[2]||(r[2]=(...c)=>a(p)&&a(p)(...c)),class:"w-full sm:w-44 py-3 mt-4 text-white bg-[#002159] rounded-xl"}," Accept "),l("button",{onClick:r[3]||(r[3]=c=>("navigateTo"in L?L.navigateTo:a(A))(`/wallet/${a(S)}`)),class:"w-full sm:w-44 py-3 mt-4 bg-white sm:border sm:border-gray-400 sm:rounded-xl"}," Decline ")])]))]))}});export{be as default};
