# UI Integration Setup - Summary

## ğŸ‰ What Was Created

### 1. **Setup Script** (`scripts/setup-ui.sh`)
Automated setup script that:
- âœ… Clones walt.id identity repository
- âœ… Installs dependencies (pnpm/yarn/npm auto-detected)
- âœ… Creates `.env.local` files for wallet and portal
- âœ… Generates helper scripts (`start-wallet.sh`, `start-portal.sh`, `build-all.sh`)
- âœ… Creates API mapping documentation

**Run it:**
```bash
./scripts/setup-ui.sh
```

### 2. **Backend Wallet Controller** (`src/controllers/wallet/WalletController.ts`)
New REST API endpoints for wallet functionality:
- `GET /api/wallet/metadata` - Get wallet info, holder DID, credentials
- `POST /api/wallet/credentials` - Store credential after issuance
- `GET /api/wallet/credentials` - List all credentials
- `GET /api/wallet/credentials/{id}` - Get specific credential
- `POST /api/wallet/credentials/{id}/delete` - Delete credential

### 3. **Tenant Helper Utilities** (`src/utils/ui-integration/tenantHelper.ts`)
Helper functions for multi-tenant routing:
- `withTenant(tenantId, path)` - Build tenant-scoped URLs
- `extractTenantFromRequest(req)` - Extract tenant from header/subdomain/query
- `buildTenantContext(req, tenantId?)` - Create full tenant context

### 4. **Documentation**
- **`docs/UI_INTEGRATION.md`** - Complete integration guide with:
  - Architecture overview
  - Quick start instructions
  - API mapping examples
  - Code snippets for UI changes
  - Testing procedures
  - Multi-tenant deployment strategies
  - Troubleshooting guide

- **`credo-ui/API_MAPPING.md`** (generated by script) - Detailed endpoint mappings

## ğŸ“‹ Existing Backend Endpoints Ready for UI

### Issuer APIs (Already Implemented)
âœ… `POST /oidc/issuer/credential-offers` - Create credential offer  
âœ… `GET /oidc/credential-offers/{code}` - Get offer details  
âœ… `POST /oidc/token` - Redeem pre-authorized code  
âœ… `GET /oidc/issuer/credentials` - List issued credentials  
âœ… `GET /oidc/issuer/credentials/{id}` - Get specific credential  
âœ… `POST /oidc/issuer/credentials/{id}/revoke` - Revoke credential  

### Verifier APIs (Already Implemented)
âœ… `POST /oidc/verifier/presentation-requests` - Create presentation request  
âœ… `POST /oidc/verifier/verify` - Verify presentation  

### Metadata APIs (Already Implemented)
âœ… `GET /{tenantId}/.well-known/openid-credential-issuer` - Issuer metadata  
âœ… `GET /{tenantId}/.well-known/openid-verifier` - Verifier metadata  
âœ… `GET /{tenantId}/issuer/did` - Get issuer DID  

### Multi-Tenancy APIs (Already Implemented)
âœ… `POST /multi-tenancy/create-tenant` - Create tenant  
âœ… `GET /multi-tenancy/{tenantId}` - Get tenant info  
âœ… `GET /multi-tenancy/{tenantId}/metadata` - Get tenant metadata  
âœ… `GET /multi-tenancy/{tenantId}/metadata/issuer` - Get issuer metadata  
âœ… `GET /multi-tenancy/{tenantId}/metadata/verifier` - Get verifier metadata  
âœ… `DELETE /multi-tenancy/{tenantId}` - Delete tenant  

## ğŸš€ Next Steps (In Order)

### Phase 1: Setup UI Components (5 minutes)
```bash
# Run the setup script
./scripts/setup-ui.sh
```

This will:
1. Clone walt.id UI into `credo-ui/waltid-identity/`
2. Install dependencies
3. Create environment files
4. Generate helper scripts

### Phase 2: Start Services (2 minutes)

**Terminal 1 - Backend:**
```bash
yarn dev
# â†’ http://localhost:3000
```

**Terminal 2 - Wallet:**
```bash
cd credo-ui && ./start-wallet.sh
# â†’ http://localhost:4001
```

**Terminal 3 - Portal:**
```bash
cd credo-ui && ./start-portal.sh
# â†’ http://localhost:5000
```

### Phase 3: Wire UI to Backend (30 minutes)

The setup script creates `.env.local` files pointing to Credo backend. You need to:

1. **Update API client base URLs** in UI code:
   - Find: `waltid-web-wallet/src/lib/api.ts` (or similar)
   - Replace walt.id URLs with `process.env.NEXT_PUBLIC_*` variables

2. **Add tenant context** to fetch calls:
   ```typescript
   headers: {
     'Authorization': `Bearer ${token}`,
     'X-Tenant-ID': tenantId
   }
   ```

3. **Test connectivity** with mock data:
   ```bash
   # In wallet UI console
   fetch('http://localhost:3000/api/wallet/metadata', {
     headers: { 'Authorization': 'Bearer <token>' }
   })
   ```

### Phase 4: Test End-to-End (15 minutes)

1. **Create tenant:**
   ```bash
   curl -X POST http://localhost:3000/multi-tenancy/create-tenant \
     -H "Authorization: Bearer test-api-key" \
     -d '{"config":{"label":"Test Merchant"}}'
   ```

2. **Create credential offer** (via portal UI or curl)

3. **Accept in wallet** (scan QR or paste offer URI)

4. **Verify credential** (verifier requests, wallet presents)

### Phase 5: Rebuild Backend Routes (5 minutes)

After adding WalletController:
```bash
yarn build
# This regenerates routes.ts and swagger.json
```

Restart backend:
```bash
yarn dev
```

### Phase 6: EcoCash Integration (Future)

Once UI flows work:
1. Add EcoCash webhook endpoint
2. On payment success â†’ create credential offer
3. Send offer URI to customer (SMS/push)
4. Customer redeems in wallet

## ğŸ“ Project Structure After Setup

```
credo-controller/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ oidc/              âœ… Already implemented
â”‚   â”‚   â”œâ”€â”€ multi-tenancy/     âœ… Already implemented
â”‚   â”‚   â””â”€â”€ wallet/            ğŸ†• New wallet controller
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ ui-integration/    ğŸ†• Tenant helpers
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ setup-ui.sh            ğŸ†• Setup script
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ UI_INTEGRATION.md      ğŸ†• Integration guide
â”‚   â””â”€â”€ DEPENDENCY_WARNINGS.md âœ… Already created
â””â”€â”€ credo-ui/                  ğŸ†• Created by setup script
    â”œâ”€â”€ waltid-identity/       ğŸ†• Cloned walt.id repo
    â”‚   â”œâ”€â”€ waltid-applications/
    â”‚   â”‚   â”œâ”€â”€ waltid-web-wallet/  (.env.local created)
    â”‚   â”‚   â””â”€â”€ waltid-web-portal/  (.env.local created)
    â”œâ”€â”€ start-wallet.sh        ğŸ†• Helper script
    â”œâ”€â”€ start-portal.sh        ğŸ†• Helper script
    â”œâ”€â”€ build-all.sh           ğŸ†• Helper script
    â””â”€â”€ API_MAPPING.md         ğŸ†• Endpoint mapping
```

## âœ… Verification Checklist

Before testing:
- [ ] Setup script ran successfully
- [ ] `credo-ui/waltid-identity/` exists
- [ ] `.env.local` files created in wallet and portal
- [ ] WalletController added to `src/controllers/wallet/`
- [ ] Backend rebuilt with `yarn build`
- [ ] Backend running on port 3000
- [ ] Wallet UI can start (even if not fully wired)
- [ ] Portal UI can start (even if not fully wired)

## ğŸ”§ If Issues Occur

### Setup script fails to clone
```bash
# Clone manually
cd credo-controller
mkdir -p credo-ui
cd credo-ui
git clone https://github.com/walt-id/waltid-identity.git
```

### Dependencies fail to install
```bash
cd credo-ui/waltid-identity
pnpm install  # or yarn install or npm install
```

### UI doesn't connect to backend
1. Check `.env.local` files have correct URLs
2. Verify CORS enabled in `src/server.ts`
3. Check backend logs for rejected requests
4. Test endpoint directly with curl

### Wallet can't store credentials
1. Verify WalletController routes generated: `yarn build`
2. Check backend logs for errors
3. Verify tenant token is valid
4. Test endpoint: `curl http://localhost:3000/api/wallet/metadata -H "Authorization: Bearer <token>"`

## ğŸ“ Support

- Check `docs/UI_INTEGRATION.md` for detailed guide
- Check `credo-ui/API_MAPPING.md` for endpoint reference
- Check `docs/LOCAL_DEV_SETUP.md` for backend setup
- Check `docs/DOCKER_DEPLOYMENT.md` for production deployment

---

**Status:** âœ… Setup infrastructure ready. Next: Run `./scripts/setup-ui.sh`
